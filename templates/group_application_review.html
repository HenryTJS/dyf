{% extends "base.html" %}

{% block title %}集体申请审核 - 德育分管理系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4>集体申请审核</h4>
                <small class="text-muted">审核教师提交的集体德育分申请</small>
                <div class="float-end">
                    <button class="btn btn-sm btn-outline-primary" onclick="loadGroupApplications()">
                        <i class="fas fa-sync-alt"></i> 刷新
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="groupApplicationsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>申请教师</th>
                                <th>申请标题</th>
                                <th>类别</th>
                                <th>学年</th>
                                <th>成员数</th>
                                <th>状态</th>
                                <th>申请时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="groupApplicationsBody">
                            <tr>
                                <td colspan="9" class="text-center">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 审核模态框 -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">审核集体申请</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="applicationDetails">
                    <!-- 申请详情将在这里显示 -->
                </div>
                <hr>
                <form id="reviewForm">
                    <input type="hidden" id="applicationId">
                    <div class="mb-3">
                        <label class="form-label">审核结果</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="statusApproved" value="approved">
                            <label class="form-check-label text-success" for="statusApproved">
                                <strong>通过</strong>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="statusRejected" value="rejected">
                            <label class="form-check-label text-danger" for="statusRejected">
                                <strong>驳回</strong>
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">审核意见</label>
                        <textarea class="form-control" id="reviewComment" rows="4" placeholder="请输入审核意见..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitReview()">提交审核</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadGroupApplications() {
    fetch('/api/group-applications')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('API返回的数据:', data); // 添加调试日志
            const tbody = document.getElementById('groupApplicationsBody');
            if (!Array.isArray(data) || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">暂无集体申请记录</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map(app => `
                <tr>
                    <td>${app.id}</td>
                    <td>${app.teacher_name || '未知教师'}</td>
                    <td>${app.title}</td>
                    <td>${app.category_name || '未知类别'}</td>
                    <td>${app.semester}</td>
                    <td>${app.member_count}</td>
                    <td>
                        <span class="badge badge-${app.status === 'approved' ? 'success' : app.status === 'rejected' ? 'danger' : 'warning'}">
                            ${app.status === 'approved' ? '已通过' : app.status === 'rejected' ? '已驳回' : '待审核'}
                        </span>
                    </td>
                    <td>${new Date(app.created_at).toLocaleString()}</td>
                    <td>
                        ${app.status === 'pending' ? 
                            `<button class="btn btn-sm btn-primary" onclick="showReviewModal(${app.id})">审核</button>` : 
                            `<button class="btn btn-sm btn-secondary" onclick="showReviewModal(${app.id})">查看</button>`
                        }
                    </td>
                </tr>
            `).join('');
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('groupApplicationsBody').innerHTML = 
                '<tr><td colspan="9" class="text-center text-danger">加载失败: ' + error.message + '</td></tr>';
        });
}

function showReviewModal(applicationId) {
    // 获取申请详情
    fetch(`/api/group-applications/${applicationId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('applicationId').value = applicationId;
            
            // 显示申请详情
            document.getElementById('applicationDetails').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>申请信息</h6>
                        <p><strong>申请教师：</strong>${data.teacher_name || '未知教师'}</p>
                        <p><strong>申请标题：</strong>${data.title}</p>
                        <p><strong>类别：</strong>${data.category_name || '未知类别'}</p>
                        <p><strong>学年：</strong>${data.semester}</p>
                        <p><strong>成员数量：</strong>${data.member_count}</p>
                        <p><strong>申请时间：</strong>${new Date(data.created_at).toLocaleString()}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>申请说明</h6>
                        <p>${data.description}</p>
                        ${data.evidence ? `<p><strong>证明材料：</strong><a href="/uploads/${data.evidence}" target="_blank">${data.evidence}</a></p>` : ''}
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>成员名单</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>学号</th>
                                        <th>姓名</th>
                                        <th>班级</th>
                                        <th>分值</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.members ? data.members.map(member => `
                                        <tr>
                                            <td>${member.student_id || ''}</td>
                                            <td>${member.student_name || ''}</td>
                                            <td>${member.class_name || ''}</td>
                                            <td>${member.score}</td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="4" class="text-center">暂无成员信息</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // 重置表单
            document.getElementById('reviewForm').reset();
            
            // 如果是已审核的申请，禁用表单
            if (data.status !== 'pending') {
                document.querySelectorAll('#reviewForm input, #reviewForm textarea').forEach(el => {
                    el.disabled = true;
                });
                document.querySelector('.modal-footer .btn-primary').style.display = 'none';
            } else {
                document.querySelectorAll('#reviewForm input, #reviewForm textarea').forEach(el => {
                    el.disabled = false;
                });
                document.querySelector('.modal-footer .btn-primary').style.display = 'block';
            }
            
            // 显示审核意见（如果有）
            if (data.review_comment) {
                document.getElementById('reviewComment').value = data.review_comment;
            }
            
            // 显示模态框
            new bootstrap.Modal(document.getElementById('reviewModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('获取申请详情失败');
        });
}

function submitReview() {
    const applicationId = document.getElementById('applicationId').value;
    const status = document.querySelector('input[name="status"]:checked');
    const reviewComment = document.getElementById('reviewComment').value;
    
    if (!status) {
        alert('请选择审核结果');
        return;
    }
    
    if (status.value === 'rejected' && !reviewComment.trim()) {
        alert('驳回申请需要填写审核意见');
        return;
    }
    
    const data = {
        status: status.value,
        review_comment: reviewComment
    };
    
    fetch(`/api/group-applications/${applicationId}/review`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        alert('审核完成');
        bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
        loadGroupApplications();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('审核失败: ' + error.message);
    });
}

// 页面加载时自动加载数据
document.addEventListener('DOMContentLoaded', loadGroupApplications);
</script>
{% endblock %}
