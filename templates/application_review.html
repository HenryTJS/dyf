{% extends "base.html" %}

{% block title %}审核申请 - 德育分管理系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4>申请审核</h4>
                <small class="text-muted">审核学生提交的德育分申请</small>
                <div class="float-end">
                    <button class="btn btn-sm btn-outline-primary" onclick="loadApplications()">
                        <i class="fas fa-sync-alt"></i> 刷新
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="applicationsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>申请人</th>
                                <th>学号</th>
                                <th>班级</th>
                                <th>申请标题</th>
                                <th>类别</th>
                                <th>申请分数</th>
                                <th>状态</th>
                                <th>申请时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="applicationsBody">
                            <tr>
                                <td colspan="10" class="text-center">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 审核模态框 -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">审核申请</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="applicationDetails">
                    <!-- 申请详情将在这里显示 -->
                </div>
                <hr>
                <div class="form-group">
                    <label for="reviewStatus" class="form-label">审核结果</label>
                    <select class="form-control" id="reviewStatus" required>
                        <option value="">请选择审核结果</option>
                        <option value="approved">通过</option>
                        <option value="rejected">拒绝</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reviewComment" class="form-label">审核意见</label>
                    <textarea class="form-control" id="reviewComment" rows="4" placeholder="请输入审核意见"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitReview()">提交审核</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentApplicationId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadApplications();
});

function loadApplications() {
    fetch('/api/applications')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('applicationsBody');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">暂无申请记录</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map(app => `
                <tr>
                    <td>${app.id}</td>
                    <td>${app.user_name}</td>
                    <td>${app.student_id}</td>
                    <td>${app.class_name}</td>
                    <td>${app.title}</td>
                    <td>${app.category_name}</td>
                    <td>${app.score}分</td>
                    <td>
                        <span class="badge badge-${app.status === 'approved' ? 'success' : app.status === 'rejected' ? 'danger' : 'warning'}">
                            ${app.status === 'approved' ? '已通过' : app.status === 'rejected' ? '已拒绝' : '待审核'}
                        </span>
                    </td>
                    <td>${formatDate(app.created_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showReviewModal(${app.id})" ${app.status !== 'pending' ? 'disabled' : ''}>
                            ${app.status === 'pending' ? '审核' : '已审核'}
                        </button>
                    </td>
                </tr>
            `).join('');
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('applicationsBody').innerHTML = '<tr><td colspan="10" class="text-center text-danger">加载失败</td></tr>';
        });
}

function showReviewModal(appId) {
    currentApplicationId = appId;
    
    // 获取申请详情
    fetch('/api/applications')
        .then(response => response.json())
        .then(data => {
            const app = data.find(a => a.id === appId);
            if (app) {
                document.getElementById('applicationDetails').innerHTML = `
                    <h6>申请详情</h6>
                    <p><strong>申请人：</strong>${app.user_name} (${app.student_id})</p>
                    <p><strong>班级：</strong>${app.class_name}</p>
                    <p><strong>申请标题：</strong>${app.title}</p>
                    <p><strong>申请类别：</strong>${app.category_name}</p>
                    <p><strong>申请分数：</strong>${app.score}分</p>
                    <p><strong>申请描述：</strong></p>
                    <div class="border p-2 bg-light">${app.description}</div>
                    ${app.evidence ? `
                        <p><strong>证明材料：</strong></p>
                        <div class="border p-2 bg-light">
                            <p class="mb-2">${app.evidence}</p>
                            <a href="/api/download/${app.evidence}" class="btn btn-sm btn-primary" target="_blank">
                                <i class="fas fa-download"></i> 下载附件
                            </a>
                        </div>
                    ` : '<p><strong>证明材料：</strong>无</p>'}
                `;
            }
        });
    
    // 重置表单
    document.getElementById('reviewStatus').value = '';
    document.getElementById('reviewComment').value = '';
    
    // 显示模态框
    new bootstrap.Modal(document.getElementById('reviewModal')).show();
}

function submitReview() {
    const status = document.getElementById('reviewStatus').value;
    const comment = document.getElementById('reviewComment').value;
    
    if (!status) {
        alert('请选择审核结果');
        return;
    }
    
    // 禁用提交按钮防止重复提交
    const submitBtn = document.querySelector('#reviewModal .btn-primary');
    submitBtn.disabled = true;
    submitBtn.textContent = '提交中...';
    
    fetch(`/api/applications/${currentApplicationId}/review`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            status: status,
            review_comment: comment
        })
    })
    .then(response => {
        console.log('审核响应状态:', response.status);
        if (!response.ok) {
            return response.json().then(errData => {
                throw new Error(errData.message || `HTTP error! status: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('审核响应数据:', data);
        if (data.message && data.message.includes('完成')) {
            alert('审核完成！');
            bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
            // 重新加载列表
            loadApplications();
        } else {
            throw new Error(data.message || '审核失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('审核失败：' + error.message);
    })
    .finally(() => {
        // 恢复按钮状态
        submitBtn.disabled = false;
        submitBtn.textContent = '提交审核';
    });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('zh-CN');
}
</script>
{% endblock %}
