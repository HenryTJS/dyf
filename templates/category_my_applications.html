{% extends "base.html" %}

{% block title %}申请记录 - {{ category.name }} - 德育分管理系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header" data-category-id="{{ category.id }}" data-category-name="{{ category.name }}">
                <h4>{{ category.name }} - 申请记录</h4>
                <small class="text-muted">查看您在此类别的所有申请记录</small>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <button class="btn btn-primary" onclick="goToApplication()">
                            <i class="fas fa-plus"></i> 新增申请
                        </button>
                    </div>
                    <div>
                        <a href="{{ url_for('my_scores') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> 返回德育分查询
                        </a>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    此页面显示该类别下的所有记录，包括您的申请记录和教师端导入的德育分记录。
                </div>
                
                <div id="applicationsList">
                    <div class="text-center text-muted">
                        <p>加载中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 从HTML元素获取模板变量
const categoryId = parseInt(document.querySelector('[data-category-id]').dataset.categoryId);
const categoryName = document.querySelector('[data-category-name]').dataset.categoryName;

document.addEventListener('DOMContentLoaded', function() {
    loadCategoryApplications();
});

function loadCategoryApplications() {
    // 同时获取申请记录、德育分记录和集体申请记录
    Promise.all([
        fetch(`/api/applications/my?category_id=${categoryId}`),
        fetch('/api/scores/my'),
        fetch('/api/group-applications')
    ])
    .then(responses => Promise.all(responses.map(r => r.json())))
    .then(([applications, scores, groupApplications]) => {
        // 创建集体申请ID到集体申请详情的映射
        const groupAppMap = {};
        if (Array.isArray(groupApplications)) {
            groupApplications.forEach(ga => {
                groupAppMap[ga.id] = ga;
            });
        }
        
        // 过滤出当前类别的德育分记录
        // 只保留集体申请来源的记录，个人申请的记录会从 applications 中显示
        const categoryScores = scores.scores.filter(score => 
            score.category_id === categoryId && 
            score.source !== '初始德育分' && 
            score.source === '集体申请'
        );
        
        // 合并申请记录和德育分记录
        const allRecords = [
            ...applications.map(app => ({
                ...app,
                type: 'application',
                recordType: '个人申请',
                status: app.status
            })),
            ...categoryScores.map(score => {
                // 如果是集体申请来源，从groupAppMap中获取详细信息
                let groupAppDetails = null;
                if (score.source === '集体申请' && score.group_application_id) {
                    groupAppDetails = groupAppMap[score.group_application_id];
                }
                
                return {
                    ...score,
                    type: score.source === '集体申请' ? 'group' : 'score',
                    recordType: score.source === '集体申请' ? '教师端集体申请' : '已通过的德育分',
                    status: '已通过',
                    title: score.description,
                    source: score.source,
                    groupAppDetails: groupAppDetails
                };
            })
        ];
        
        // 按时间排序
        allRecords.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        
        displayApplications(allRecords);
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('applicationsList').innerHTML = '<p class="text-center text-muted">加载失败</p>';
    });
}

function displayApplications(applications) {
    const applicationsDiv = document.getElementById('applicationsList');
    
    if (applications.length === 0) {
        applicationsDiv.innerHTML = '<p class="text-center text-muted">暂无申请记录</p>';
        return;
    }
    
    const applicationsHtml = applications.map(app => {
        let statusBadge = '';
        let statusClass = '';
        
        switch(app.status) {
            case 'pending':
                statusBadge = '待审核';
                statusClass = 'warning';
                break;
            case 'approved':
            case '已通过':
                statusBadge = '已通过';
                statusClass = 'success';
                break;
            case 'rejected':
                statusBadge = '被拒绝';
                statusClass = 'danger';
                break;
            default:
                statusBadge = app.status || '未知';
                statusClass = 'secondary';
        }
        
        // 根据类型设置标签
        let recordTypeBadge = '';
        let recordTypeClass = '';
        if (app.type === 'application') {
            recordTypeBadge = '个人申请';
            recordTypeClass = 'primary';
        } else if (app.type === 'group') {
            recordTypeBadge = '教师端集体申请';
            recordTypeClass = 'info';
        } else {
            recordTypeBadge = '德育分记录';
            recordTypeClass = 'success';
        }
        
        // 构建额外信息（用于集体申请）
        let extraInfo = '';
        if (app.type === 'group' && app.groupAppDetails) {
            const ga = app.groupAppDetails;
            extraInfo = `
                <div class="mt-2 p-2 bg-light border-left border-info" style="border-left-width: 3px !important;">
                    <p class="mb-1 text-muted" style="font-size: 0.9rem;">
                        <i class="fas fa-user-tie"></i> <strong>提交教师：</strong>${ga.teacher_name || '未知'}
                    </p>
                    ${ga.description ? `
                        <p class="mb-1 text-muted" style="font-size: 0.9rem;">
                            <strong>申请说明：</strong>${ga.description}
                        </p>
                    ` : ''}
                    ${ga.review_comment ? `
                        <p class="mb-1 text-info" style="font-size: 0.9rem;">
                            <strong>审核意见：</strong>${ga.review_comment}
                        </p>
                    ` : ''}
                    ${ga.evidence ? `
                        <p class="mb-0">
                            <a href="/api/download/${ga.evidence}" class="btn btn-sm btn-outline-primary" target="_blank">
                                <i class="fas fa-download"></i> 查看证明材料
                            </a>
                        </p>
                    ` : ''}
                </div>
            `;
        }
        
        return `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <h6 class="card-title mb-0">
                                    ${app.type === 'group' ? '<i class="fas fa-users mr-1"></i>' : ''}
                                    ${app.title || app.description}
                                </h6>
                                <span class="badge badge-${recordTypeClass} ml-2">${recordTypeBadge}</span>
                            </div>
                            <p class="card-text text-muted mb-2">
                                <strong>分数：</strong>${app.score}分 | 
                                <strong>时间：</strong>${new Date(app.created_at).toLocaleString()}
                                ${app.academic_year ? ` | <strong>学年：</strong>${app.academic_year}` : ''}
                            </p>
                            ${app.type === 'application' && app.description && app.description !== (app.title || '') ? `
                                <p class="card-text text-muted"><strong>详细描述：</strong>${app.description}</p>
                            ` : ''}
                            ${app.type === 'application' && app.review_comment ? `
                                <p class="card-text text-info"><strong>审核意见：</strong>${app.review_comment}</p>
                            ` : ''}
                            ${app.type === 'application' && app.evidence ? `
                                <p>
                                    <a href="/api/download/${app.evidence}" class="btn btn-sm btn-outline-primary" target="_blank">
                                        <i class="fas fa-download"></i> 查看证明材料
                                    </a>
                                </p>
                            ` : ''}
                            ${extraInfo}
                        </div>
                        <div class="ml-3">
                            <span class="badge badge-${statusClass}">${statusBadge}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    applicationsDiv.innerHTML = applicationsHtml;
}

function goToApplication() {
    window.location.href = `/application/category/${categoryId}?name=${encodeURIComponent(categoryName)}`;
}
</script>
{% endblock %}
